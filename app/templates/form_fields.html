{% extends "base.html" %}

{% block content %}
  <div class="row align-items-start justify-content-between mb-3"> 
    <div class="col-12 col-lg-8">
      <h1 class="d-flex align-items-center gap-2 flex-wrap"> 
        <span>Customize Data Extraction Form — {{ project.name }}</span>
        {% if role_label %}
          <span class="badge text-bg-light">{{ role_label }}</span>
        {% endif %}
      </h1>
    </div>
  </div>

  {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}
    <div class="alert alert-info">You are a project member. Changes you make here will be submitted for owner approval.</div>
  {% endif %}

  <div class="mb-3 d-flex flex-column flex-sm-row gap-2">
    <a class="btn btn-primary" href="{{ url_for('add_form_field', project_id=project.id) }}">Add Field</a>
    <a class="btn btn-secondary" href="{{ url_for('project_detail', project_id=project.id) }}">Back to Project</a>
    {% if current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first()) %}
      <a class="btn btn-outline-secondary" href="{{ url_for('list_change_requests', project_id=project.id) }}">Pending Requests{% if pending_count and pending_count > 0 %} ({{ pending_count }}){% endif %}</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('manage_members', project_id=project.id) }}">Members</a>
    {% endif %}
  </div>

  {% if grouped_fields %}
    {% for sec in grouped_fields %}
      <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0 h5">{{ sec.name }}</h4>
          <div class="d-flex align-items-center gap-1">
            <form method="POST" action="{{ url_for('move_form_section_up', project_id=project.id, section=sec.name) }}" style="display:inline" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Section Up" {% if loop.first %}disabled{% endif %}>↑</button>
            </form>
            <form method="POST" action="{{ url_for('move_form_section_down', project_id=project.id, section=sec.name) }}" style="display:inline" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Section Down" {% if loop.last %}disabled{% endif %}>↓</button>
            </form>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 30%">Label</th>
                  <th style="width: 15%">Type</th>
                  <th style="width: 8%">Required</th>
                  <th style="width: 22%">Help Text</th>
                  <th style="width: 25%">Actions</th>
                </tr>
              </thead>
            <tbody>
              {% for f in sec.fields %}
              <tr>
                <td>{{ f.label }}</td>
                <td>{{ f.field_type }}</td>
                <td>{{ 'Yes' if f.required else 'No' }}</td>
                <td>
                  {% if f.help_text %}
                    <span class="text-muted small">{{ f.help_text }}</span>
                  {% else %}
                    <span class="text-muted fst-italic">No help text</span>
                  {% endif %}
                </td>
                <td>
                  <form method="POST" action="{{ url_for('move_form_field_up', project_id=project.id, field_id=f.id) }}" style="display:inline" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Up">↑</button>
                  </form>
                  <form method="POST" action="{{ url_for('move_form_field_down', project_id=project.id, field_id=f.id) }}" style="display:inline" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Down">↓</button>
                  </form>
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_form_field', project_id=project.id, field_id=f.id) }}">Edit</a>
                  <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{{ url_for('delete_form_field', project_id=project.id, field_id=f.id) }}" data-confirm-message="Delete field &quot;{{ f.label }}&quot;? This action cannot be undone." data-confirm-title="Delete Field" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>Delete</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No fields yet. Use "Add Field" to create your form.</p>
  {% endif %}

  <!-- Outcomes management -->
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0 h5">Project Outcomes</h4>
      <span class="text-muted small">Define outcomes suggested during data entry</span>
    </div>
    <div class="card-body">
      {% if outcomes and outcomes|length > 0 %}
        <ul class="list-group mb-3">
          {% for o in outcomes|sort(attribute='name') %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-semibold">{{ o.name }}</span>
                <span class="badge text-bg-light ms-2">{{ o.outcome_type }}</span>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{{ url_for('delete_project_outcome', project_id=project.id, outcome_id=o.id) }}" data-confirm-message="Delete outcome &quot;{{ o.name }}&quot;?" data-confirm-title="Delete Outcome" {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}data-requires-reason="true"{% endif %}>Delete</button>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted mb-3">No predefined outcomes yet.</div>
      {% endif %}

      <form method="POST" action="{{ url_for('add_project_outcome', project_id=project.id) }}" class="row g-2 align-items-end">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="col-12 col-md-7">
          {{ outcome_form.name.label(class="form-label") }}
          {{ outcome_form.name(class="form-control", placeholder="e.g., Mortality at 30 days") }}
        </div>
        <div class="col-12 col-md-3">
          {{ outcome_form.outcome_type.label(class="form-label") }}
          {{ outcome_form.outcome_type(class="form-select") }}
        </div>
        {% if not (current_user.is_admin or (project.memberships.filter_by(user_id=current_user.id, role='owner').first())) %}
          <div class="col-12">
            {{ outcome_form.reason.label(class="form-label") }}
            {{ outcome_form.reason(class="form-control", rows=2, placeholder="Explain why this outcome should be added") }}
          </div>
        {% endif %}
        <div class="col-12 col-md-2">{{ outcome_form.submit(class="btn btn-primary w-100") }}</div>
      </form>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmDeleteMessage">
          Are you sure you want to delete this item? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form id="confirmDeleteForm" method="POST" action="#">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="reason" id="deleteFieldReason">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const deleteModal = document.getElementById('confirmDeleteModal');
    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const url = button.getAttribute('data-delete-url');
        const form = document.getElementById('confirmDeleteForm');
        form.setAttribute('action', url);
        const title = button.getAttribute('data-confirm-title') || 'Confirm Delete';
        const message = button.getAttribute('data-confirm-message') || 'Are you sure you want to delete this item?';
        const titleEl = document.getElementById('confirmDeleteModalLabel');
        const messageEl = document.getElementById('confirmDeleteMessage');
        if (titleEl) {
          titleEl.textContent = title;
        }
        if (messageEl) {
          messageEl.innerHTML = message;
        }
        // If member, prompt a reason and set hidden field
        const requires = button.hasAttribute('data-requires-reason');
        const reasonEl = document.getElementById('deleteFieldReason');
        if (requires && reasonEl) {
          const r = prompt('Optional: reason for this request');
          reasonEl.value = (r || '').trim();
        } else if (reasonEl) {
          reasonEl.value = '';
        }
      });
    }

    // For member actions, prompt an optional reason and inject into form
    document.addEventListener('submit', function (e) {
      const form = e.target;
      if (form && form.hasAttribute('data-requires-reason')) {
        const r = prompt('Optional: reason for this request');
        if (r !== null) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'reason';
          input.value = (r || '').trim();
          form.appendChild(input);
        }
      }
    });
  </script>
{% endblock %}
