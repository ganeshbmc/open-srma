{% extends "base.html" %}

{% block content %}
  <h1>Customize Data Extraction Form — {{ project.name }}</h1>

  <div class="mb-3">
    <a class="btn btn-primary" href="{{ url_for('add_form_field', project_id=project.id) }}">Add Field</a>
    <a class="btn btn-secondary" href="{{ url_for('project_detail', project_id=project.id) }}">Back to Project</a>
  </div>

  {% if fields %}
    {# Group fields by section to avoid repeating headers #}
    {% for group in fields|groupby('section') %}
      <div class="card mt-4">
        <div class="card-header">
          <h4 class="mb-0 h5">{{ group.grouper }}</h4>
        </div>
        <div class="card-body p-0">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 40%">Label</th>
                <th style="width: 20%">Type</th>
                <th style="width: 10%">Required</th>
                <th style="width: 30%">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for f in group.list %}
              <tr>
                <td>{{ f.label }}</td>
                <td>{{ f.field_type }}</td>
                <td>{{ 'Yes' if f.required else 'No' }}</td>
                <td>
                  <form method="POST" action="{{ url_for('move_form_field_up', project_id=project.id, field_id=f.id) }}" style="display:inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Up">↑</button>
                  </form>
                  <form method="POST" action="{{ url_for('move_form_field_down', project_id=project.id, field_id=f.id) }}" style="display:inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit" title="Move Down">↓</button>
                  </form>
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_form_field', project_id=project.id, field_id=f.id) }}">Edit</a>
                  <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{{ url_for('delete_form_field', project_id=project.id, field_id=f.id) }}">Delete</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No fields yet. Use "Add Field" to create your form.</p>
  {% endif %}

  <!-- Delete confirmation modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this field? This action cannot be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form id="confirmDeleteForm" method="POST" action="#">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const deleteModal = document.getElementById('confirmDeleteModal');
    if (deleteModal) {
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const url = button.getAttribute('data-delete-url');
        const form = document.getElementById('confirmDeleteForm');
        form.setAttribute('action', url);
      });
    }
  </script>
{% endblock %}
