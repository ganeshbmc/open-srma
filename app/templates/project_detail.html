{% extends "base.html" %}

{% block content %}
    <div class="d-flex align-items-start justify-content-between mb-3">
      <div>
        <h1 class="mb-1 d-flex align-items-center gap-2">
          <span>{{ project.name }}</span>
          {% if role_label %}
            <span class="badge text-bg-light">{{ role_label }}</span>
          {% endif %}
        </h1>
        {% if project.description %}
          <p class="text-muted mb-0">{{ project.description }}</p>
        {% endif %}
      </div>
      <div class="text-end d-flex flex-wrap justify-content-end gap-2">
        <a href="{{ url_for('list_form_fields', project_id=project.id) }}" class="btn btn-outline-secondary">Customize Form{% if is_owner_or_admin and pending_count and pending_count > 0 %} <span class="badge text-bg-warning">{{ pending_count }}</span>{% endif %}</a>

        <div class="btn-group">
          <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Export</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="{{ url_for('export_static', project_id=project.id, format='csv') }}">Static Fields (CSV)</a>
            </li>
            <li>
              {% if outcome_row_count > 0 %}
                <a class="dropdown-item" href="{{ url_for('export_outcomes', project_id=project.id) }}">Outcomes (zip)</a>
              {% else %}
                <button type="button" class="dropdown-item disabled" data-bs-toggle="tooltip" data-bs-title="No outcomes recorded yet">Outcomes (zip)</button>
              {% endif %}
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="{{ url_for('export_all_zip', project_id=project.id) }}">Export All Data (zip)</a>
            </li>
          </ul>
        </div>

        {% if is_owner_or_admin %}
          <a href="{{ url_for('list_change_requests', project_id=project.id) }}" class="btn btn-outline-secondary">Requests{% if pending_count and pending_count > 0 %} ({{ pending_count }}){% endif %}</a>
          <a href="{{ url_for('manage_members', project_id=project.id) }}" class="btn btn-outline-secondary">Members</a>
          <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">Delete Project</button>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Studies</h2>
        <a href="{{ url_for('add_study', project_id=project.id) }}" class="btn btn-primary btn-sm">Add Study</a>
      </div>
      <div class="list-group list-group-flush">
        {% if studies %}
          {% for study in studies %}
            <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <div class="fw-semibold">{{ study.title }}</div>
                {% set sid = study_id_map.get(study.id) if study_id_map else None %}
                {% if sid %}
                  <div class="text-muted small">{{ sid }}</div>
                {% else %}
                  <div class="text-muted small">{{ study.author }}, {{ study.year }}</div>
                {% endif %}
              </div>
              <div class="d-flex gap-2">
                <a href="{{ url_for('enter_data', project_id=project.id, study_id=study.id) }}" class="btn btn-sm btn-outline-primary">Enter Data</a>
                {% if is_owner_or_admin %}
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteStudyModal" data-delete-url="{{ url_for('delete_study', project_id=project.id, study_id=study.id) }}" data-study-title="{{ study.title }}">Delete</button>
                {% elif is_member %}
                  <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteStudyModal" data-delete-url="{{ url_for('delete_study', project_id=project.id, study_id=study.id) }}" data-study-title="{{ study.title }}" data-requires-approval="true">Request Delete</button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="list-group-item text-muted">No studies added yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="mt-3">
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Projects</a>
    </div>

    <!-- Delete Project Modal -->
    <div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteProjectLabel">Delete Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <div class="fw-semibold">This action is permanent.</div>
              <div>Deleting the project will also remove:</div>
              <ul class="mb-0">
                <li>{{ study_count }} associated study/studies and their data</li>
                <li>{{ field_count }} custom form fields</li>
              </ul>
            </div>
            <div class="mb-3">
              <a class="btn btn-outline-primary" href="{{ url_for('export_all_zip', project_id=project.id) }}" target="_blank" rel="noopener">Export all data (zip)</a>
            </div>
            <p>Type the project name to confirm:</p>
            <input type="text" class="form-control" id="confirmProjectName" placeholder="{{ project.name }}">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form method="POST" action="{{ url_for('delete_project', project_id=project.id) }}" onsubmit="return confirmDeleteProject()">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-danger" id="deleteProjectBtn" disabled>Delete Project</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete/Request Study Modal -->
    <div class="modal fade" id="deleteStudyModal" tabindex="-1" aria-labelledby="deleteStudyLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteStudyLabel">Delete Study</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="deleteStudyMessage">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form method="POST" action="#" id="deleteStudyForm">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="reason" id="deleteStudyReason">
              <button type="submit" class="btn btn-danger" id="deleteStudySubmit">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Enable tooltips for disabled actions
      document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
      const projectName = {{ project.name|tojson }};
      const inputEl = document.getElementById('confirmProjectName');
      const deleteBtn = document.getElementById('deleteProjectBtn');
      function syncConfirm() {
        deleteBtn.disabled = (inputEl.value || '').trim() !== projectName;
      }
      function confirmDeleteProject() {
        return (inputEl.value || '').trim() === projectName;
      }
      if (inputEl && deleteBtn) {
        inputEl.addEventListener('input', syncConfirm);
      }

      const deleteStudyModal = document.getElementById('deleteStudyModal');
      if (deleteStudyModal) {
        deleteStudyModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          const studyTitle = button.getAttribute('data-study-title') || 'this study';
          const deleteUrl = button.getAttribute('data-delete-url');
          const requiresApproval = button.hasAttribute('data-requires-approval');

          const form = document.getElementById('deleteStudyForm');
          const messageEl = document.getElementById('deleteStudyMessage');
          const reasonInput = document.getElementById('deleteStudyReason');
          const submitBtn = document.getElementById('deleteStudySubmit');

          form.setAttribute('action', deleteUrl || '#');
          if (requiresApproval) {
            deleteStudyModal.querySelector('.modal-title').textContent = 'Request Study Deletion';
            messageEl.textContent = `Submit a deletion request for "${studyTitle}"? Project owners will review it.`;
            submitBtn.textContent = 'Submit Request';
            const reason = prompt('Optional: reason for this request');
            if (reasonInput) {
              reasonInput.value = (reason || '').trim();
            }
          } else {
            deleteStudyModal.querySelector('.modal-title').textContent = 'Delete Study';
            messageEl.textContent = `Are you sure you want to delete "${studyTitle}"? This removes all extracted data for this study.`;
            submitBtn.textContent = 'Delete';
            if (reasonInput) {
              reasonInput.value = '';
            }
          }
        });
      }
    </script>
{% endblock %}
